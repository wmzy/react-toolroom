import{r as l,j as c}from"./index-0983955d.js";import{n as w,t as j,a as y,b as R}from"./util-2d0d1589.js";const h=new WeakMap;function E(t){const e=l.useRef();e.current=[t,[],{}];const r=l.useCallback((...s)=>{const[n,o]=e.current,u={};return o.reduce((d,a)=>a(d,u),n)(...s)},[]);return h.set(r,e),r}function p(t){return h.get(t).current[2]}function f(t,e){h.get(t).current[1].push(e)}function L(){const[t,e]=l.useState(0);return[!!t,s=>(e(n=>n+1),s.finally(()=>e(n=>n-1)))]}function C(){const[t,e]=L();return[t,s=>(...n)=>e(s(...n))]}function b({cacheTime:t,hash:e}){const r=new Map;let s=0,n;return{get(o){const u=e(o);return r.get(u)},set(o,u){r.set(e(o),[u,Date.now()])},delete(o){r.delete(e(o))},clear(){r.clear()},use(){if(t===1/0)return w;s++;let o=!1;return n!==void 0&&clearTimeout(n),()=>{o||(o=!0,--s===0&&(n=setTimeout(()=>{r.clear(),n=void 0},t)))}}}}const g=Symbol("set result");function k(t,e){const[r,s]=l.useState(e),n=p(t);return n[g]=s,f(t,o=>(...u)=>o(...u).then(j(s))),r}function S(t,e,r=0){const s=p(t),n=l.useRef(!1);return l.useEffect(e.use,[]),f(t,o=>(...u)=>{const d=s[g],a=()=>o(...u).then(i=>(e.set(u,i),d(i),n.current=!1,i));return new Promise(i=>{i(e.get(u))}).then(i=>{if(!i)return a();const[x,m]=i;return n.current=Date.now()-m>=r,n.current&&a(),x}).catch(a)}),n.current}function A(t){const[e,r]=l.useState();return f(t,s=>(...n)=>s(...n).then(y(()=>r(void 0))).catch(R(r))),e}function v(t){const[e,r]=C();return f(t,r),e}function I(t,e){l.useEffect(()=>void t(...e),e)}function D(t){return new Promise(e=>{setTimeout(e,t)})}function M(t){return{id:t,username:`user ${t}`,description:"...",updatedAt:Date.now()}}function*T(t){let e=1;for(;e<t;)yield e++;return e}async function U(t){if(console.log("fetch list start"),await D(5e3),t&&t<0)throw console.log("fetch list fail"),new Error("PARAMS ERROR: [size] could not lower than 0");return console.log("fetch list done"),Array.from(T(10)).map(M)}const N=b({cacheTime:1e4,hash:t=>JSON.stringify(t)});function B(){const t=E(U),e=S(t,N,2e3),r=k(t),s=v(t),n=A(t);return I(t,[]),s?"loading...":n?c.jsxs("div",{children:[c.jsx("h1",{children:n.message}),c.jsx("pre",{children:n.stack}),c.jsx("button",{type:"button",onClick:()=>t(),children:"refresh"})]}):c.jsxs("div",{children:[c.jsx("h1",{className:"cpy0lx",children:"User List"}),c.jsxs("div",{children:[c.jsx("button",{type:"button",onClick:()=>t(),children:"refresh"}),c.jsx("button",{type:"button",onClick:()=>t(-1),children:"refresh(Error)"})]}),e&&c.jsx("p",{children:"data was stale"}),c.jsx("ul",{children:r==null?void 0:r.map(o=>c.jsx("li",{children:o.username},o.id))})]})}export{B as default};
